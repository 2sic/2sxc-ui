<div class="content" *ngFor="let app of [state.app$ | async]">
  <span (click)="tabIndex = 0">testing</span>
  <!-- loading indicator -->
  <md-progress-bar [ngStyle]="{ opacity: (ready$ | async) ? 0 : 1 }" [mode]="'indeterminate'"></md-progress-bar>

  <!-- main dialog, starting with save/cancel button -->
  <div *ngIf="ready$ | async" class="card">
    <div class="top-controls" fxLayout="row" fxLayoutAlign="center center">
      <button md-fab *ngIf="state.template" (click)="persistTemplate()" [attr.title]="'TemplatePicker.Save' | translate">
        <md-icon>check</md-icon>
      </button>
      <button md-mini-fab class="secondary" *ngIf="undoTemplateId !== null" (click)="cancel()" [attr.title]="('TemplatePicker.' + (isContentApp ? 'Cancel' : 'Close')) | translate">
        <md-icon>close</md-icon>
      </button>
    </div>

    <!-- tabs -->
    <md-tab-group [(selectedIndex)]="tabIndex">
      <md-tab>
        <ng-template md-tab-label>
          {{(isContentApp 
            ? (state.contentType?.Name || ('TemplatePicker.ContentTypePickerDefault' | translate)) 
            : (app?.name || ('TemplatePicker.AppPickerDefault' | translate)))}}
        </ng-template>

        <!-- App Selector -->
        <div *ngIf="!isContentApp; else contentApp" class="tiles">

          <div class="tile" [ngClass]="{ active: app?.appId === a.appId }" 
            [attr.title]="a.name" 
            (click)="app?.appId === a.appId ? switchTab() : updateApp(a)"
            (dblclick)="switchTab()" *ngFor="let a of apps$ | async">
            <div class="bg">
              <img *ngIf="a.thumbnail !== null && a.thumbnail !== ''" class="bg-img" [attr.src]="a.thumbnail + '?w=176&h=176'">
              <div *ngIf="a.thumbnail === null || a.thumbnail === ''" class="bg-icon">
                <md-icon>star</md-icon>
              </div>
            </div>

            <div class="title" [ngClass]="{ show: a.thumbnail === null || a.thumbnail === '' }">
              <span>{{a.name}}</span>
            </div>
          </div>

          <!-- install and manage buttons -->
          <div class="tile config" *ngIf="showAdvanced" (click)="run('app-import')" [attr.title]="'TemplatePicker.Install' | translate">
            <div class="bg">
              <div class="bg-icon">
                <md-icon>get_app</md-icon>
              </div>
            </div>
            <div class="title show">
              <span>{{"TemplatePicker.Install" | translate}}</span>
            </div>
          </div>
          <div class="tile config" *ngIf="showAdvanced" (click)="run('zone')" [attr.title]="'TemplatePicker.Zone' | translate">
            <div class="bg">
              <div class="bg-icon">
                <md-icon>apps</md-icon>
              </div>
            </div>
            <div class="title show">
              <span>{{"TemplatePicker.Zone" | translate}}</span>
            </div>
          </div>
        </div>

        <!-- Content-Type selection (when not a generic app, but the default content-app -->
        <ng-template #contentApp>
          <div class="tiles">
            <div md-button class="tile" [ngClass]="{ active: state.contentType?.StaticName === c.StaticName, blocked: !allowContentTypeChange }"
              [attr.title]="c.Label | translate" (click)="state.contentType?.StaticName === c.StaticName ? switchTab() : updateContentType(c)"
              (dblclick)="switchTab()" *ngFor="let c of state.contentTypes">
              <div class="bg">
                <img *ngIf="c.Thumbnail !== null && c.Thumbnail !== ''" class="bg-img" [attr.src]="c.Thumbnail + '?w=176&h=176'">
                <div *ngIf="c.Thumbnail === null || c.Thumbnail === ''" class="bg-icon">
                  <md-icon>bubble_chart</md-icon>
                </div>
              </div>
              <div class="title" [ngClass]="{ show: c.Thumbnail === null || c.Thumbnail === '' }">
                <span>{{c.Label | translate}}</span>
              </div>
            </div>
          </div>
        </ng-template>
      </md-tab>

      <!-- template selection after app/content-type selection -->
      <md-tab *ngIf="isContentApp ? state.contentType : app" [label]="('TemplatePicker.ChangeView' | translate) + '(' + state.templates.length + ')'">
        <div class="tiles">
          <md-spinner class="templates-spinner" *ngIf="loadingTemplates"></md-spinner>
          <div class="tile" [ngClass]="{ active: state.template?.TemplateId === t.TemplateId }" [attr.title]="t.Name" (click)="setTemplate(t)"
            *ngFor="let t of state.templates">
            <div class="bg">
              <img *ngIf="t.Thumbnail !== null && t.Thumbnail !== ''" class="bg-img" [attr.src]="t.Thumbnail + '?w=176&h=176'">
              <div *ngIf="t.Thumbnail === null || t.Thumbnail === ''" class="bg-icon">
                <md-icon *ngIf="isContentApp">view_carousel</md-icon>
                <md-icon *ngIf="!isContentApp">view_quilt</md-icon>
              </div>
            </div>
            <div class="title" [ngClass]="{ show: t.Thumbnail === null || t.Thumbnail === '' }">
              <span>{{t.Name}}</span>
            </div>
          </div>
          <div class="tile config" *ngIf="showAdvanced && !isContentApp && app?.appId !== null" (click)="run('app')" [attr.title]="'TemplatePicker.App' | translate">
            <div class="bg">
              <div class="bg-icon">
                <md-icon>settings</md-icon>
              </div>
            </div>
            <div class="title show">
              <span>{{"TemplatePicker.App" | translate}}</span>
            </div>
          </div>
        </div>
      </md-tab>
    </md-tab-group>

    <span class="no-install-allowed" *ngIf="isInnerContent && showInstaller">No {{isContentApp ? 'Content Apps' : 'Apps'}} installed yet. Please persue the installation by creating a new {{isContentApp ? 'Content' : 'App'}} in the root of your website.</span>
    <app-installer *ngIf="!isInnerContent && showInstaller" [isContentApp]="isContentApp"></app-installer>
  </div>
</div>

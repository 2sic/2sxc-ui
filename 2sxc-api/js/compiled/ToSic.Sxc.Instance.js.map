{"version":3,"file":"ToSic.Sxc.Instance.js","sourceRoot":"","sources":["../ToSic.Sxc.Instance.ts"],"names":[],"mappings":"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","sourcesContent":["\r\nimport { SxcController, SxcControllerWithInternals } from \"./ToSic.Sxc.Controller\";\r\nimport { SxcDataWithInternals } from \"./ToSic.Sxc.Data\";\r\nimport { SxcWebApiWithInternals } from \"./ToSic.Sxc.WebApi\";\r\n/**\r\n * The typical sxc-instance object for a specific DNN module or content-block\r\n */\r\nexport class SxcInstance {\r\n    /**\r\n     * helpers for ajax calls\r\n     */\r\n    webApi: SxcWebApiWithInternals;\r\n    protected serviceRoot: string;\r\n    private readonly serviceScopes = [\"app\", \"app-sys\", \"app-api\", \"app-query\", \"app-content\", \"eav\", \"view\", \"dnn\"];\r\n\r\n    constructor(\r\n        /**\r\n         * the sxc-instance ID, which is usually the DNN Module Id\r\n         */\r\n        public id: number,\r\n\r\n        /**\r\n         * content-block ID, which is either the module ID, or the content-block definitiion entity ID\r\n         * this is an advanced concept you usually don't care about, otherwise you should research it\r\n         */\r\n        public cbid: number,\r\n        protected readonly dnnSf: any,\r\n    ) {\r\n        this.serviceRoot = dnnSf(id).getServiceRoot(\"2sxc\");\r\n        this.webApi = new SxcWebApiWithInternals(this, id, cbid);\r\n    }\r\n\r\n    /**\r\n     * converts a short api-call path like \"/app/Blog/query/xyz\" to the DNN full path\r\n     * which varies from installation to installation like \"/desktopmodules/api/2sxc/app/...\"\r\n     * @param virtualPath\r\n     * @returns mapped path\r\n     */\r\n    resolveServiceUrl(virtualPath: string) {\r\n        const scope = virtualPath.split(\"/\")[0].toLowerCase();\r\n\r\n        // stop if it's not one of our special paths\r\n        if (this.serviceScopes.indexOf(scope) === -1)\r\n            return virtualPath;\r\n\r\n        return this.serviceRoot + scope + \"/\" + virtualPath.substring(virtualPath.indexOf(\"/\") + 1);\r\n    }\r\n\r\n\r\n    // Show a nice error with more infos around 2sxc\r\n    showDetailedHttpError(result: any): any {\r\n        if (window.console)\r\n            console.log(result);\r\n\r\n        if (result.status === 404 &&\r\n            result.config &&\r\n            result.config.url &&\r\n            result.config.url.indexOf(\"/dist/i18n/\") > -1) {\r\n            if (window.console)\r\n                console.log(\"just fyi: failed to load language resource; will have to use default\");\r\n            return result;\r\n        }\r\n\r\n\r\n        // if it's an unspecified 0-error, it's probably not an error but a cancelled request,\r\n        // (happens when closing popups containing angularJS)\r\n        if (result.status === 0 || result.status === -1)\r\n            return result;\r\n\r\n        // let's try to show good messages in most cases\r\n        let infoText = \"Had an error talking to the server (status \" + result.status + \").\";\r\n        const srvResp = result.responseText\r\n            ? JSON.parse(result.responseText) // for jquery ajax errors\r\n            : result.data; // for angular $http\r\n        if (srvResp) {\r\n            const msg = srvResp.Message;\r\n            if (msg) infoText += \"\\nMessage: \" + msg;\r\n            const msgDet = srvResp.MessageDetail || srvResp.ExceptionMessage;\r\n            if (msgDet) infoText += \"\\nDetail: \" + msgDet;\r\n\r\n\r\n            if (msgDet && msgDet.indexOf(\"No action was found\") === 0)\r\n                if (msgDet.indexOf(\"that matches the name\") > 0)\r\n                    infoText += \"\\n\\nTip from 2sxc: you probably got the action-name wrong in your JS.\";\r\n                else if (msgDet.indexOf(\"that matches the request.\") > 0)\r\n                    infoText += \"\\n\\nTip from 2sxc: Seems like the parameters are the wrong amount or type.\";\r\n\r\n            if (msg && msg.indexOf(\"Controller\") === 0 && msg.indexOf(\"not found\") > 0)\r\n                infoText +=\r\n                    // tslint:disable-next-line:max-line-length\r\n                    \"\\n\\nTip from 2sxc: you probably spelled the controller name wrong or forgot to remove the word 'controller' from the call in JS. To call a controller called 'DemoController' only use 'Demo'.\";\r\n\r\n        }\r\n        // tslint:disable-next-line:max-line-length\r\n        infoText += \"\\n\\nif you are an advanced user you can learn more about what went wrong - discover how on 2sxc.org/help?tag=debug\";\r\n        alert(infoText);\r\n\r\n        return result;\r\n    }\r\n}\r\n\r\n/**\r\n * Enhanced sxc instance with additional editing functionality\r\n * Use this, if you intend to run content-management commands like \"edit\" from your JS directly\r\n */\r\nexport class SxcInstanceWithEditing extends SxcInstance {\r\n    /**\r\n     * manage object which provides access to additional content-management features\r\n     * it only exists if 2sxc is in edit mode (otherwise the JS are not included for these features)\r\n     */\r\n    manage: any = null; // initialize correctly later on\r\n\r\n    constructor(\r\n        public id: number,\r\n        public cbid: number,\r\n// ReSharper disable once InconsistentNaming\r\n        protected $2sxc: SxcControllerWithInternals,\r\n        protected readonly dnnSf: any,\r\n    ) {\r\n        super(id, cbid, dnnSf);\r\n\r\n        // add manage property, but not within initializer, because inside the manage-initializer it may reference 2sxc again\r\n        try { // sometimes the manage can't be built, like before installing\r\n            if ($2sxc._manage) $2sxc._manage.initInstance(this);\r\n        } catch (e) {\r\n            console.error('error in 2sxc - will only log but not throw', e);\r\n            // throw e;\r\n        }\r\n\r\n        // this only works when manage exists (not installing) and translator exists too\r\n        if ($2sxc._translateInit && this.manage) $2sxc._translateInit(this.manage);    // init translate, not really nice, but ok for now\r\n\r\n    }\r\n\r\n    /**\r\n     * checks if we're currently in edit mode\r\n     * @returns {boolean}\r\n     */\r\n    isEditMode() {\r\n        return this.manage && this.manage._isEditMode();\r\n    }\r\n\r\n}\r\n\r\nexport class SxcInstanceWithInternals extends SxcInstanceWithEditing {\r\n    data: SxcDataWithInternals;\r\n    source: any = null;\r\n    isLoaded = false;\r\n    lastRefresh: Date = null;\r\n\r\n    constructor(\r\n        public id: number,\r\n        public cbid: number,\r\n        private cacheKey: string,\r\n// ReSharper disable once InconsistentNaming\r\n        protected $2sxc: SxcControllerWithInternals,\r\n        protected readonly dnnSf: any,\r\n    ) {\r\n        super(id, cbid, $2sxc, dnnSf);\r\n        this.data = new SxcDataWithInternals(this);\r\n    }\r\n\r\n    recreate(resetCache: boolean): SxcInstanceWithInternals {\r\n        if (resetCache) delete this.$2sxc._controllers[this.cacheKey]; // clear cache\r\n        return this.$2sxc(this.id, this.cbid) as any as SxcInstanceWithInternals; // generate new\r\n    }\r\n}\r\n"]}